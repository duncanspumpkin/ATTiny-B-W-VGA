.include "tn45def.INC"

.equ BWHITE=2
.equ HSYNC=1
.equ VSYNC=0
.equ VGADDR=DDRB
.equ VGAPIN=PINB
.equ VGAPORT=PORTB
.equ HORIZONTALLINES = 636
.equ VERTICALLINES = 525 ;0x20d
.equ VERTICALSYNCPULSE = 2 ;0x002
;Vertical should start at 34 but since we are only outputing 20 pixels 
; of 5 times size 100 we start a bit later
.equ VERTICALACTIVESTART = 34 + (514-34-100)/2 ;0x022
.equ VERTICALACTIVEEND = 514 - (514-34-100)/2 ;0x202

.equ OUTPUTFRAME = SRAM_START ;This is 10 bytes long and address to what we are outputing

.def VERTLINENOL=r0 ;Permantly used for Vertical line no.
.def VERTLINENOH=r1

.def TILELINEL=r2
.def TILELINEH=r3
;Register r4,r6-r8 & r17 are also used by interrupt do not use.

.org 0
rjmp RESET

.org OC1Aaddr
; This is used to equalise interrupt latency
	sei ;1
	nop ;1 OVF1addr
	nop ;1 OVF0addr
	nop ;1 ERDYaddr
	nop	;1 ACIaddr
; Note do not use Timer 0/1 overflow, EEPROM ready and Analog Comparator interrupts
.org OC1Baddr
rjmp VIDEO

RESET:
	ldi r16,(1<<BWHITE)|(1<<HSYNC)|(1<<VSYNC)
	out VGADDR,r16

	ldi r16,low(RAMEND)
	out SPL,r16
	ldi r16,high(RAMEND)
	out SPH,r16

	; SET TIMER1 to fire interrupt on OCR1A match
	ldi r16,(1<<OCIE1A)|(1<<OCIE1B)
	out TIMSK,r16

	;Note that I am filling in OCR1C with values not OCR1A its
	;stupid but the only way this will work.

	; SET TIMER1 INTERRUPT TIME A VALUE
	ldi r16,(HORIZONTALLINES/4-1)
	out OCR1C,r16



	; SET TIMER1 TO SCLK WITH RESET COMPARING AGAINST OCR1C
	ldi r16,(1<<CS10)|(1<<CS11)|(1<<CTC1)
	out TCCR1,r16

	; Load in a basic frame
	ldi xl,low(OUTPUTFRAME)
	ldi xh,high(OUTPUTFRAME)
	ldi zl,low(2*TILE1)
	ldi zh,high(2*TILE1)
	st X+,ZL
	st X+,ZH	
	ldi zl,low(2*TILE2)
	ldi zh,high(2*TILE2)
	st X+,ZL
	st X+,ZH	
	ldi zl,low(2*TILE3)
	ldi zh,high(2*TILE3)
	st X+,ZL
	st X+,ZH	
	ldi zl,low(2*TILE4)
	ldi zh,high(2*TILE4)
	st X+,ZL
	st X+,ZH	
	ldi zl,low(2*TILE5)
	ldi zh,high(2*TILE5)
	st X+,ZL
	st X+,ZH
	
	;Setup Output stuff
	clr r4 ;1
	clr TILELINEL;1
	clr TILELINEH;1

	; Set TIME OCR1B we do this after a period of time so that the first
	; interrupt occurs properly
	ldi r16,2
	out OCR1B,r16	
	sei
LOOP:
	rjmp LOOP

; HORIZONTAL CLOCK TIMING
;HFP:12 (0-11)
;HSP:76 (12-87)
;HBP:36 (88-123)
;HPX:512 (124-635)
;TOT:636

; VERTICAL LINE TIMING
;VSP:2 (0-1)
;VBP:32 (2-33)
;VLN:480 (34-513)
;VFP:11 (514-524) 
;TOT:525 LINES
VIDEO:
;******************************
;* We have just left the HFP after 18 cycles now in HSP for 76 cycles
;******************************
	; Setup
	; Time  = 11 cycles
	cbi VGAPORT,HSYNC ;2
	;Save the status register
	push r16 ;2
	pop r16 ;2
	pop r16 ;2	
	push r19 ;2
	in r17,sreg ;1

	;Increment line
	; TIME = 3 cycles
	inc VERTLINENOL;1
	brne VERTADD ;2/1
	 inc VERTLINENOH;1
	VERTADD:
	
	;Reset Line count
	; Time = 11
	ldi r19,low(VERTICALLINES) ;1
	ldi r16,high(VERTICALLINES) ;1
	; Check to see if we need to start from the
	; begining.
	cp r19,VERTLINENOL ;1
	cpc r16,VERTLINENOH ;1
	breq restartVertCount ;1/2
	 nop ;-
	 nop ;-
	 nop ;3
	 rjmp noRestartVertCount ;2
	restartVertCount:
	 clr VERTLINENOL ;1
	 clr VERTLINENOH ;1
	 cbi VGAPORT,VSYNC ;2
	noRestartVertCount:
	clr r19 ;1

	; VERTICAL SYNC OFF AT LINE 2
	; TIME = 7 CYCLES
	ldi r16,low(VERTICALSYNCPULSE) ;1
	;ldi r17,high(VERTICALSYNCPULSE) ;1
	cp r16,VERTLINENOL ;1
	cpc r19,VERTLINENOH ;1
	breq s3 ;1/2
	 nop ;1
	 rjmp s4 ;2
	s3:
	sbi VGAPORT,VSYNC ;2
	s4:

	; Stop doing work if this is a blank
	; line.
	; ACTIVE PIXELS ON AT LINE 34
	; TIME = 6 CYCLES
	ldi r16,low(VERTICALACTIVESTART) ;1
	;ldi r17,high(VERTICALACTIVESTART) ;1
	cp r16,VERTLINENOL ;1
	cpc r19,VERTLINENOH ;1
	brlo activePixOn;2/1
	 rjmp activePixOnEnd ;2
activePixOn:
	set ;1
activePixOnEnd:

	; ACTIVE PIXELS OFF AT LINE 514
	; Time = 7 Cyclces
	ldi r16,low(VERTICALACTIVEEND) ;1
	ldi r19,high(VERTICALACTIVEEND) ;1
	cp r16,VERTLINENOL ;1
	cpc r19,VERTLINENOH ;1
	brlo activePixOff ;2/1
	 rjmp activePixOffEnd
activePixOff:
	clt ;1
activePixOffEnd:

 	; Fix timer
	; Time = 4 cycles
	clr r16 ;1
	out TCCR1,r16 ;1
	ldi r16,(1<<CS10)|(1<<CS11)|(1<<CTC1);1
	out TCCR1,r16 ;1
	; 49 Cycles

	;9 cycles
	tst VERTLINENOL ;1
	breq  resetLinesC1;2/1 branch if zero
	nop ;1
	nop ;1
	nop ;1
	nop ;1
	nop ;1
	rjmp noresetLines ;2
resetLinesC1:
	tst VERTLINENOH ;1
	breq resetLinesC2 ;2/1
	nop	
	nop
	rjmp noresetLines ;2
resetLinesC2:
	clr r4 ;1
	clr TILELINEL;1
	clr TILELINEH;1
noresetLines:

	nop
	nop
	nop
	nop
	nop
	nop
	nop
	nop
	nop
	nop
	nop
	nop ;Add in code for moving Z and X regs
	nop
	nop
	nop
	nop 
	nop ;17
	sbi VGAPORT,HSYNC ;2
; ****************************************************************************************
; **** HORIZONTAL BACK PORCH = 36 CYCLES
; ****************************************************************************************
	brts novid1;2/1
	rjmp novid ;2 Doesn't matter as this wont be run if there is vid
novid1:
	;11 cycles
	inc r4 ;1
	ldi r16,0x5;1
	cp r4,r16 ;1
	breq newLine;2/1
	nop ;1
	nop ;1
	nop ;1
	nop ;1
	rjmp noNewLine ;2
newLine:
	clr r4 ;1
	ldi r16,low((TILELINE3-TILELINE1));1 There is a good reason why this is 3
	ldi r19,high((TILELINE3-TILELINE1));1
	add TILELINEL,r16 ;1
	adc TILELINEH,r19 ;1

noNewLine:
	
	nop
	nop
	nop
	nop
	nop
	nop
	nop
	nop
	nop
	

	ldi XL,low(OUTPUTFRAME) ;1
	ldi XH,high(OUTPUTFRAME) ;1
	ld ZL,X+ ;2
	ld ZH,X+ ;2
	add ZL,TILELINEL ;1
	adc ZH,TILELINEH ;1
	lpm r8,Z+ ;3	
	ldi r16,5 ;1 There are 512 cycles we only output on 500 with 5 characters
	in r7,VGAPORT ;1
	bst r8,0 ;1
	nop ;1
; ****************************************************************************************
; **** HORIZONTAL ACTIVE LINE = 512 CYCLES / 4 = 128 PIXELS
; ****************************************************************************************	
	bld r7,BWHITE ;1
vidOut:	
	out VGAPORT,r7 ;1 - 1	
	bst r8,1 ;1
	bld r7,BWHITE ;1
	bst r8,2 ;1
	nop ;1
	out VGAPORT,r7 ;1 - 2
	lpm r6,Z+ ;3
	bld r7,BWHITE ;1
	out VGAPORT,r7 ;1 - 3
	bst r8,3 ;1
	bld r7,BWHITE ;1
	nop ;1
	nop ;1
	out VGAPORT,r7 ;1 - 4
	bst r8,4 ;1
	bld r7,BWHITE ;1
	nop ;1
	nop ;1
	out VGAPORT,r7 ;1 - 5
	bst r8,5 ;1
	bld r7,BWHITE ;1
	nop ;1
	nop ;1
	out VGAPORT,r7 ;1 - 6
	bst r8,6 ;1
	bld r7,BWHITE ;1
	nop ;1
	nop ;1
	out VGAPORT,r7 ;1 - 7
	bst r8,7 ;1
	bld r7,BWHITE ;1
	mov r8,r6 ;1
	nop ;1
	out VGAPORT,r7 ;1 - 8
	bst r8,0 ;1
	bld r7,BWHITE ;1
	nop ;1
	nop ;1
	out VGAPORT,r7 ;1 - 9
	bst r8,1 ;1
	bld r7,BWHITE ;1
	nop ;1
	nop ;1
	out VGAPORT,r7 ;1 - 10
	bst r8,2 ;1
	bld r7,BWHITE ;1
	nop ;1
	nop ;1
	out VGAPORT,r7 ;1 - 11
	bst r8,3 ;1
	bld r7,BWHITE ;1
	bst r8,4 ;1
	nop ;1
	out VGAPORT,r7 ;1 - 12
	bld r7,BWHITE ;1
	lpm r6,Z+ ;3
	out VGAPORT,r7 ;1 - 13
	bst r8,5
	bld r7,BWHITE ;1
	ld ZL,X+ ;2
	out VGAPORT,r7 ;1 - 14
	bst r8,6 ;1
	bld r7,BWHITE ;1
	ld ZH,X+ ;2
	out VGAPORT,r7 ;1 - 15
	bst r8,7;1
	bld r7,BWHITE ;1
	mov r8,r6
	bst r8,0;1
	out VGAPORT,r7 ;1 - 16
	bld r7,BWHITE ;1
	bst r8,1
	add ZL,TILELINEL ;1
	adc ZH,TILELINEH ;1	
	out VGAPORT,r7 ;1 - 17
	bld r7,BWHITE ;1
	bst r8,2 ;1
	dec r16 ;1
	nop ;1
	out VGAPORT,r7 ;1 - 18
	bld r7,BWHITE ;1
	lpm r6,Z+ ;3
	out VGAPORT,r7 ;1 - 19
	bst r8,3 ;1
	bld r7,BWHITE ;1 
	mov r8,r6 ;1
	bst r8,0 ;1
	out VGAPORT,r7 ;1 - 20
	bld r7,BWHITE ;1
	breq noVid ;2/1
	rjmp vidOut ;2
novid:
	cbi VGAPORT,BWHITE ;2
	;Check that we have the final black band Should also reset output to off
	pop r19 ;2
	pop r16 ;2
	out sreg,r17 ;1
	reti ;4

TILE1:
TILELINE1:
.db 0xAA,0x10,0x0A,\
 	0xAA,0x10,0x0A
TILELINE3:
.db 0xAA,0x10,0x0A,\
	0xAA,0x10,0x0A,\
	0xAA,0x10,0xA0,\
	0xAA,0x10,0xA0,\
	0xAA,0x10,0xA0,\
	0xAA,0x10,0xA0,\
	0xAA,0x10,0xA0,\
	0xAA,0x10,0xA0,\
	0xAA,0x10,0xA0,\
	0xAA,0x10,0xA0,\
	0xAA,0x10,0xA0,\
	0xAA,0x10,0xA0,\
	0xAA,0x01,0xA0,\
	0xAA,0x01,0xA0,\
	0xAA,0x01,0xA0,\
	0xAA,0x01,0xA0,\
	0xAA,0x01,0xA0,\
	0xAA,0x01,0xA0
TILE2:
.db 0x10,0xCB,0xA0,\
 	0xAA,0x10,0xA0,\
	0xAA,0xCB,0x01,\
	0xAA,0x10,0xA0,\
	0x10,0xCB,0xA0,\
	0xAA,0x10,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0x10,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0x10,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0x10,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0x10,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0x10,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0x10,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0x10,0xAF
TILE3:
.db 0xA1,0xCB,0xA0,\
 	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA1
TILE4:
.db 0xAA,0xCB,0xA1,\
 	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xA1,0xCB,0xA0
TILE5:
.db 0xA1,0xCB,0xA0,\
 	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA1
TILE6:
.db 0xAA,0xCB,0xA0,\
 	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0
TILE7:
.db 0xAA,0xCB,0xA0,\
 	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0
TILE8:
.db 0xAA,0xCB,0xA0,\
 	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0
TILE9:
.db 0xAA,0xCB,0xA0,\
 	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0
TILE10:
.db 0xAA,0xCB,0xA0,\
 	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0
TILE11:
.db 0xAA,0xCB,0xA0,\
 	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0
TILE12:
.db 0xAA,0xCB,0xA0,\
 	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0,\
	0xAA,0xCB,0xA0
